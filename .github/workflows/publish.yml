import requests, os, time

# Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Secrets
TOKEN = os.getenv('FB_TOKEN')
PAGE_ID = os.getenv('PAGE_ID')

def start_engine():
    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙƒØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    if os.path.exists("v.mp4"): os.remove("v.mp4")
    if os.path.exists("final.mp4"): os.remove("final.mp4")

    print("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙÙŠØ¯ÙŠÙˆ ØªØ±Ù†Ø¯...")
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù‚Ù†Ø§Ø© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰
    cmd_dl = "yt-dlp -f 'best[ext=mp4]' --max-downloads 1 --match-filter 'duration < 60' -o 'v.mp4' 'https://www.youtube.com/@SatisfyingWorld/shorts'"
    os.system(cmd_dl)

    if os.path.exists("v.mp4"):
        print("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙƒØ³Ø± Ø§Ù„Ø­Ù‚ÙˆÙ‚...")
        # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (Reverse & Scale)
        os.system("ffmpeg -i v.mp4 -vf 'hflip,scale=1080:1920' -c:a copy final.mp4 -y")
        
        if os.path.exists("final.mp4"):
            print("ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ...")
            url = f"https://graph.facebook.com/v18.0/{PAGE_ID}/video_reels"
            
            # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø·Ù„Ø¨ Ø§Ù„Ø±ÙØ¹
            init = requests.post(url, data={'upload_phase': 'start', 'access_token': TOKEN}).json()
            
            if 'video_id' in init:
                video_id = init['video_id']
                # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
                with open("final.mp4", 'rb') as f:
                    requests.post(init['upload_url'], data=f, headers={'Authorization': f'OAuth {TOKEN}'})
                
                print("â³ Ø§Ù†ØªØ¸Ø± 60 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...")
                time.sleep(60) # ÙˆÙ‚Øª Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„ÙÙŠØ³Ø¨ÙˆÙƒ
                
                # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                res = requests.post(url, data={
                    'upload_phase': 'finish', 'video_id': video_id, 
                    'video_state': 'PUBLISHED', 'description': 'Amazing Gadgets! âœ¨ #ZainWorld', 
                    'access_token': TOKEN
                }).json()
                print(f"ğŸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {res}")
            else:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: {init}")
    else:
        print("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨.")

if __name__ == "__main__":
    start_engine()
